{% extends 'base.html' %}
{% load static %}

{% block title %}DevGuru - {{ question.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/question.css' %}">
{% endblock %}

{% block content %}
<div class="left-column">
    <div class="question-full">
        <div class="question-avatar">
        {% if question.author.avatar %}
            <img src="{{ question.author.avatar.url }}" alt="avatar">
        {% else %}
            <img src="{% static 'avatars/default-avatar.png' %}" alt="avatar">
        {% endif %}
        </div>
        <div class="question-full-content">
            <h2 class="question-full-title">{{ question.title }}</h2>
            <div class="question-full-body">
                <p>{{ question.detailed }}</p>
            </div>
            <div class="question-full-meta">
                <div class="question-full-tags">
                    {% for tag in question.tags.all %}
                    <a href="{% url 'tag' tag.name %}" class="tag">{{ tag.name }}</a>
                    {% endfor %}
                </div>
                <div class="question-full-stats">
                    <button
                        type="button"
                        class="like-btn like-question-btn {% if question.is_liked %}like-btn--active{% else %}like-btn--inactive{% endif %}"
                        data-question-id="{{ question.id }}"
                        data-liked="{% if question.is_liked %}true{% else %}false{% endif %}">
                        <i class="{% if question.is_liked %}fas{% else %}far{% endif %} fa-heart"></i>
                    </button>
                    <span
                        class="question-full-likes"
                        id="question-{{ question.id }}-rating">
                        {{ question.rating }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="answers-sort-tabs">
        <a href="?sort=best"
        class="answers-sort-tab {% if answers_sort == 'best' %}answers-sort-tab--active{% endif %}">
            Лучшие ответы
        </a>
        <a href="?sort=new"
        class="answers-sort-tab {% if answers_sort == 'new' %}answers-sort-tab--active{% endif %}">
            Последние
        </a>
    </div>

    <div class="answers-section">
        <h3 class="answers-section-title">Ответы</h3>

        {% for answer in answers %}
        <div class="answer">
            <div class="answer-content">
                <div class="answer-avatar">
                    {% if answer.author.avatar %}
                        <img src="{{ answer.author.avatar.url }}" alt="Текущий аватар" class="settings-current-avatar">
                    {% else %}
                        <img src="{% static '/avatars/default-avatar.png' %}" alt="Нет аватара" class="settings-current-avatar">
                    {% endif %}
                </div>
                <div class="answer-main">
                    <div class="answer-text">
                        <p>{{ answer.answer_text }}</p>

                        {% if answer.is_correct %}
                            <span class="answer-correct-badge">
                                <span class="answer-correct-badge-icon">✓</span>
                                Правильный ответ
                            </span>
                        {% endif %}
                    </div>          
                    <div class="answer-meta">                       
                        <div class="answer-like-wrapper">
                            <button
                                type="button"
                                class="like-btn like-answer-btn {% if answer.is_liked %}like-btn--active{% else %}like-btn--inactive{% endif %}"
                                data-answer-id="{{ answer.id }}"
                                data-liked="{% if answer.is_liked %}true{% else %}false{% endif %}">
                                <i class="{% if answer.is_liked %}fas{% else %}far{% endif %} fa-heart"></i>
                            </button>
                            <span
                                class="answer-likes"
                                id="answer-{{ answer.id }}-rating">
                                {{ answer.rating }}
                            </span>
                        </div>

                        {% if user.is_authenticated and user == question.author %}
                            <button
                                type="button"
                                class="answer-mark-correct-btn {% if answer.is_correct %}answer-mark-correct-btn--active{% endif %}"
                                data-answer-id="{{ answer.id }}">
                                {% if answer.is_correct %}
                                    ✓ Правильный ответ
                                {% else %}
                                    Отметить как правильный
                                {% endif %}
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        {% include 'pagination.html' with page=answers %}
    </div>

    <div class="your-answer">
        <h3 class="your-answer-title">Ваш ответ</h3>        
        {% if user.is_authenticated %}
            <form class="your-answer-form" method="post">
                {% csrf_token %}
                {{ answer_form.non_field_errors }}
                {{ answer_form.answer_text.errors }}
                <textarea
                    name="answer_text"
                    class="form-control"
                    rows="6"
                    placeholder="Напишите развёрнутый ответ..."></textarea>
                <button type="submit" class="btn btn--primary">Отправить</button>
            </form>
        {% else %}
            <p>Чтобы оставить ответ, <a href="{% url 'login' %}">войдите</a>.</p>
        {% endif %}    
    </div>
</div>

<div class="right-column">
    {% include 'sidebar.html' %}
</div>

{% endblock %}